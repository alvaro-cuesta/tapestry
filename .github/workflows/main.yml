name: '"main" branch workflow'

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint-tsc:
    name: Lint TypeScript

    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript Compiler
        run: npm run lint:tsc

  lint-prettier:
    name: Lint Prettier

    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run Prettier
        run: npm run lint:prettier

  lint-eslint:
    name: Lint ESLint

    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint:eslint

  build:
    name: Build static files
    needs: [lint-tsc, lint-prettier, lint-eslint]

    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Determine GitHub Pages BASE
        id: set-base
        uses: octokit/request-action@v2.4.0
        with:
          route: GET /repos/${{ github.repository }}/pages

      - name: Set BASE env var
        run: |
          CNAME=$(echo "${{ steps.set-base.outputs.data }}" | jq -r '.cname // empty')
          if [ -n "$CNAME" ]; then
            BASE="/"
          else
            REPO_NAME=$(basename "${GITHUB_REPOSITORY}")
            BASE="/${REPO_NAME}/"
          fi
          echo "TAPESTRY_BASE=$BASE" >> $GITHUB_ENV

      - name: Build static files
        run: npm run build
        env:
          BASE: $TAPESTRY_BASE

      - name: Upload static files as artifact
        id: deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/

  deploy:
    name: Deploy to GitHub Pages
    needs: build

    permissions:
      pages: write # to deploy to Pages
      id-token: write # to verify the deployment originates from an appropriate source

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
